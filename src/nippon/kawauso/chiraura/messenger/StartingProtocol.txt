1. 接続元 --> 接続先。
   アプリケーション共通鍵 (comKey0) による暗号化
  [
    通信用公開鍵 (pubKey1)、
  ]

2. 接続元 <-- 接続先。
  通信用公開鍵 (pubKey1) による暗号化
  [
    通信用共通鍵 (comKey1)、
  ]

3. 接続元 --> 接続先。
  通信用共通鍵 (comKey1) による暗号化
  [
    接続元識別用公開鍵 (id1)、
    接続元識別用公開鍵と組になる秘密鍵 (id1Pri) による暗号化
    [
      通信用共通鍵 (comKey1)
    ]
    署名用バイト列 (watchword)
    接続元アプリケーションプロトコルバージョン (ver1),
    接続元受け付けポート番号 (port1)、
    接続種別 (type)、
    接続元から見える接続先 (address1),
  ]

3.5. 接続元のポート試験を行う。

4-1(ポート有効). 接続元 <-- 接続先。
  通信用共通鍵 (comKey1) による暗号化
  [
    接続先識別用公開鍵 (id2)、
    接続元識別用公開鍵と組になる秘密鍵 (id2Pri) による暗号化
    [
      署名用バイト列 (watchword)
    ]、
    通信用公開鍵 (pubKey2),
    接続元アプリケーションプロトコルバージョン (ver2),
    接続先から見える接続元 (address2),
  ]

4-2(ポート無効). 接続元 <-- 接続先。
  通信用共通鍵 (comKey1) による暗号化
  [
  ]


署名するバイト列は相手が用意したものでなければならない。
そうでないと、成り済まされる。

通信用公開鍵は鍵更新時に用いる。


ポート試験は、接続先から接続元に新たに接続を開いて行う。

3.5.1. 接続元 <-- 接続先。
  アプリケーション共通鍵 (comKey0) による暗号化
  [
    接続元識別用公開鍵 (id1) による暗号化
    [
      通信用共通鍵 (comKey2)、
    ]
  ]

3.5.2 接続元 --> 接続先。
  通信用共通鍵 (comKey2) による暗号化
  [
    通信用共通鍵 (comKey2)のチェックサム,
  ]
